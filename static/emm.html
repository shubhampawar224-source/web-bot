<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simple Chat Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./css/style.css">
<link rel="stylesheet" href="./css/popup.css">
<!-- Fallback CSS paths -->
<link rel="stylesheet" href="/static/css/style.css">
<link rel="stylesheet" href="/static/css/popup.css">
<style>
  /* Additional CSS to ensure proper rendering */
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow-x: hidden;
  }
  
  /* Force proper box-sizing */
  *, *::before, *::after {
    box-sizing: border-box;
  }
  
  body {
    background-color: #f5f6fa !important;
  }
  
  /* Hide sidebar and navbar completely */
  .sidebar-toggle,
  .left-sidebar,
  .navbar {
    display: none !important;
  }
  
  /* Ensure chat container works properly without navbar */
  .chat-container,
  #chat-container {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    bottom: 20px !important;
    width: 450px;
    height: calc(100vh - 40px) !important;
    max-width: calc(100vw - 40px) !important;
    max-height: calc(100vh - 40px) !important;
  }
  
  /* Toast styling override */
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    min-width: 220px;
    max-width: 400px;
    background-color: #2ecc71;
    color: white;
    padding: 12px 18px;
    border-radius: 8px;
    font-weight: 500;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    z-index: 9999;
    word-wrap: break-word;
    line-height: 1.4;
    display: none;
  }
  
  .toast.error {
    background-color: #e74c3c;
  }
  
  .toast.success {
    background-color: #2ecc71;
  }
  
  /* Responsive for mobile */
  @media (max-width: 600px) {
    .chat-container,
    #chat-container {
      width: calc(100vw - 20px) !important;
      right: 10px !important;
      left: 10px !important;
      height: calc(100vh - 30px) !important;
      top: 10px !important;
    }
  }
  
  /* Enhanced Message Formatting */
  .numbered-item {
    margin: 8px 0;
    display: flex;
    align-items: flex-start;
    gap: 8px;
    line-height: 1.6;
  }
  
  .numbered-item .number {
    font-weight: 600;
    color: #4a90e2;
    min-width: 24px;
    flex-shrink: 0;
  }
  
  .bullet-item {
    margin: 6px 0;
    display: flex;
    align-items: flex-start;
    gap: 8px;
    line-height: 1.6;
  }
  
  .bullet-item .bullet {
    color: #4a90e2;
    font-weight: bold;
    min-width: 16px;
    flex-shrink: 0;
  }
  
  /* Enhanced Typing Indicator */
  .typing-indicator {
    background-color: #f0f8ff !important;
    border-left: 3px solid #4a90e2 !important;
    animation: fadeInTyping 0.3s ease-in !important;
  }
  
  .typing-indicator .dot {
    width: 6px !important;
    height: 6px !important;
    background-color: #4a90e2 !important;
    border-radius: 50% !important;
    animation: typingDots 1.4s infinite ease-in-out !important;
    margin: 0 1px !important;
  }
  
  .typing-indicator .dot:nth-child(2) {
    animation-delay: 0.2s !important;
  }
  
  .typing-indicator .dot:nth-child(3) {
    animation-delay: 0.4s !important;
  }
  
  .typing-indicator .dot:nth-child(4) {
    animation-delay: 0.6s !important;
  }
  
  @keyframes fadeInTyping {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes typingDots {
    0%, 60%, 100% {
      opacity: 0.3;
      transform: scale(0.8);
    }
    30% {
      opacity: 1;
      transform: scale(1.2);
    }
  }
  
  /* Message content formatting */
  .message p {
    margin: 0 0 8px 0;
    line-height: 1.6;
  }
  
  .message p:last-child {
    margin-bottom: 0;
  }
  
  .message br {
    line-height: 1.8;
  }
  
  /* Session Controls */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .session-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .session-id {
    font-size: 14px;
    opacity: 0.8;
  }
  
  .new-chat-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
  }
  
  .new-chat-btn:hover {
    background: rgba(255, 255, 255, 0.3);
  }
  
  /* Session Status */
  .session-status {
    font-size: 11px;
    color: #666;
    text-align: center;
    padding: 4px 0;
    border-bottom: 1px solid #eee;
    background: #f9f9f9;
  }
  
  /* Contact Form Button Fixes */
  #contactSubmit {
    background-color: #4a90e2 !important;
    color: white !important;
    border: none !important;
    padding: 10px 20px !important;
    border-radius: 5px !important;
    cursor: pointer !important;
    font-size: 14px !important;
    transition: background-color 0.3s !important;
    min-width: 80px !important;
  }
  
  #contactSubmit:hover {
    background-color: #357abd !important;
  }
  
  #contactSubmit:disabled {
    background-color: #ccc !important;
    cursor: not-allowed !important;
  }
  
  /* Ensure modal is above iframe content */
  #contactModal {
    position: fixed !important;
    z-index: 10000 !important;
  }
</style>
</head>

<body>

<!-- Chat Icon -->
<div class="chat-icon" id="chat-icon">üí¨</div>

<!-- Chat Container -->
<div class="chat-container" id="chat-container">
    <div class="header">
        Chat Assistant
        <div class="session-controls">
            <span class="session-id" title="Session ID">üí¨</span>
            <button class="new-chat-btn" onclick="startNewChat()" title="Start New Conversation">üîÑ</button>
            <button class="new-chat-btn" onclick="testContactForm()" title="Test Contact Form">üìã</button>
        </div>
    </div>

    <div id="chat-box"></div>

    <!-- Typing indicator inside chat box -->
    <div id="chat-loader" class="chat-typing" style="display:none">
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
    </div>

    <div class="chat-input">
        <input type="text" id="user-input" placeholder="Ask anything...">
        <button id="send-btn">Send</button>
    </div>
</div>

<!-- Contact Form Modal -->
<div id="contactModal" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="contactTitle">
    <div class="modal-header">
      <h2 id="contactTitle">Provide Your Contact Details</h2>
      <button class="modal-close" aria-label="Close">&times;</button>
    </div>

    <div class="modal-form">
      <div class="grid-2">
        <div>
          <label for="fname">First Name</label>
          <input type="text" id="fname" placeholder="First Name">
        </div>
        <div>
          <label for="lname">Last Name</label>
          <input type="text" id="lname" placeholder="Last Name">
        </div>
      </div>

      <label for="email">Email</label>
      <input type="email" id="email" placeholder="Email">

      <label for="phone">Phone Number</label>
      <input type="text" id="phone" placeholder="Phone Number">

      <div class="modal-actions">
        <button id="contactSkip" class="btn secondary">Skip</button>
        <button id="contactSubmit" class="btn primary">Submit</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Contact form is handled by inline JavaScript below -->
<!-- <script src="./js/popup.js"></script> -->
<!-- <script src="/static/js/popup.js"></script> -->

<script>
document.addEventListener("DOMContentLoaded", () => {
    // ---------- Default Parameters ----------
    const DEFAULT_PARAMS = {
        firm_id: "1", // Changed to string format as requested
        url_ids: "1",
        user_id: "1"
    };

    // ---------- Session Management ----------
    let currentSessionId = localStorage.getItem('chat_session_id');
    let isRestoredSession = false;
    
    // If no existing session, create a new one
    if (!currentSessionId) {
        currentSessionId = crypto.randomUUID();
        localStorage.setItem('chat_session_id', currentSessionId);
        console.log('New session created:', currentSessionId);
    } else {
        isRestoredSession = true;
        console.log('Session restored:', currentSessionId);
    }
    
    // Function to reset session if needed
    function resetChatSession() {
        currentSessionId = crypto.randomUUID();
        localStorage.setItem('chat_session_id', currentSessionId);
        console.log('New chat session started:', currentSessionId);
    }
    
    // Global function for new chat button
    window.startNewChat = function() {
        if (confirm('Start a new conversation? This will clear the current chat history.')) {
            resetChatSession();
            chatBox.innerHTML = '';
            greeted = false;
            addMessage("Hello! I'm your assistant. How can I help you today?", "bot");
            updateSessionStatus();
        }
    }
    
    // Global function to test contact form
    window.testContactForm = function() {
        console.log('Testing contact form...');
        showContactModal();
    }
    
    function updateSessionStatus() {
        const sessionElement = document.querySelector('.session-id');
        if (sessionElement) {
            sessionElement.title = `Session: ${currentSessionId.substring(0, 8)}...`;
        }
    }

    // ---------- DOM Elements ----------
    const chatIcon = document.getElementById("chat-icon");
    const chatContainer = document.getElementById("chat-container");
    const chatBox = document.getElementById("chat-box");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const toast = document.getElementById("toast");
    const chatLoader = document.getElementById("chat-loader");

    let greeted = false;

    // ---------- Chat Icon Toggle ----------
    chatIcon.addEventListener("click", () => {
        const isVisible = chatContainer.style.display === "flex";
        chatContainer.style.display = isVisible ? "none" : "flex";
        
        if (!isVisible && !greeted) {
            setTimeout(() => {
                if (isRestoredSession) {
                    addMessage("Welcome back! I'm continuing our conversation. How can I help you?", "bot");
                } else {
                    addMessage("Hello! I'm your assistant. How can I help you today?", "bot");
                }
                greeted = true;
                updateSessionStatus();
            }, 500);
        }
    });

    // ---------- Send Message Function ----------
    async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        // Add user message
        addMessage(message, "user");
        userInput.value = "";
        
        // Show typing indicator
        showTyping();

        try {
            // Send to backend with default parameters
            const payload = {
                ...DEFAULT_PARAMS,
                session_id: currentSessionId,
                query: message
            };

            console.log('Sending payload:', payload);

            const response = await fetch("/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Received response:', data);

            // Hide typing indicator
            hideTyping();

            // Add bot response using proper response handling
            if (data && (data.response || data.answer)) {
                const responseText = data.response || data.answer;
                await handleBotResponse(responseText);
            } else if (data.error) {
                addMessage(`Sorry, I encountered an error: ${data.error}`, "bot");
            } else {
                addMessage("‚ö†Ô∏è No valid response from assistant.", "bot");
            }

        } catch (error) {
            console.error("Error sending message:", error);
            hideTyping();
            addMessage("‚ö†Ô∏è Network error or backend issue occurred.", "bot");
        }
    }

    // ---------- Response Handling Functions (Enhanced) ----------
    function formatResponse(resp) {
        if (!resp) return "";
        
        let formatted = String(resp || "");
        
        // Handle numbered lists (1. 2. 3. etc.)
        formatted = formatted.replace(/^(\d+)\.\s+(.+)$/gm, '<div class="numbered-item"><span class="number">$1.</span> $2</div>');
        
        // Handle bullet points
        formatted = formatted.replace(/^[‚Ä¢\-\*]\s+(.+)$/gm, '<div class="bullet-item"><span class="bullet">‚Ä¢</span> $1</div>');
        
        // Handle line breaks for better readability
        formatted = formatted.replace(/\n\n/g, '</p><p>');
        formatted = formatted.replace(/\n/g, '<br>');
        
        // Wrap in paragraph if not already formatted
        if (!formatted.includes('<div class="numbered-item">') && !formatted.includes('<div class="bullet-item">')) {
            formatted = '<p>' + formatted + '</p>';
        }
        
        // Parse markdown-style links
        return parseMarkdownLinks(formatted);
    }

    function parseMarkdownLinks(text) {
        if (!text) return "";
        
        // Convert [text](url) to HTML links
        return text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
    }

    async function handleBotResponse(responseText) {
        let consumed = false;
        
        // Try to parse structured JSON response
        try {
            let parsed = typeof responseText === "string" ? JSON.parse(responseText) : responseText;
            if (parsed && parsed.action === "SHOW_CONTACT_FORM") {
                const botMsgDiv = addMessage("", "bot");
                const assistantText = parsed.message || "Before we finish, please share your contact details.";
                await typeMessage(botMsgDiv, assistantText, 3);

                // Open contact modal with delay
                setTimeout(() => {
                    showContactModal();
                }, 2000);

                consumed = true;
            }
        } catch (e) {
            // Not JSON or parsing failed -> treat as regular text
            consumed = false;
        }

        if (!consumed) {
            const botMsgDiv = addMessage("", "bot");
            await typeMessage(botMsgDiv, responseText, 3);
        }
    }

    async function typeMessage(containerEl, resp, speed = 2) {
        const html = formatResponse(resp);

        // If HTML contains complex tags (lists/numbered items), show immediately
        if (/<div class="(numbered-item|bullet-item)"/.test(html) || /<\/?[a-z][\s\S]*>/i.test(html)) {
            containerEl.innerHTML = html;
            // Add a small delay to simulate loading
            await new Promise(r => setTimeout(r, 300));
            return;
        }

        // Natural typing simulation for simple text
        const baseDelay = 8; // Faster baseline for better UX
        const jitterFactor = 0.3; // Less randomness

        const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

        containerEl.innerHTML = "";
        const plainText = html.replace(/<[^>]*>/g, ''); // Strip HTML for typing
        
        for (let i = 0; i < plainText.length; i++) {
            const ch = plainText.charAt(i);
            containerEl.textContent += ch;

            // Determine delay
            let delay = baseDelay * (speed || 1);

            // Shorter pause for spaces
            if (ch === " ") {
                delay *= 0.5;
            }

            // Longer pause for punctuation
            if (/[.!?]/.test(ch)) {
                delay += baseDelay * 8;
            } else if (/[,;:]/.test(ch)) {
                delay += baseDelay * 4;
            }

            // Add slight randomness
            delay += (Math.random() - 0.5) * baseDelay * jitterFactor;

            // Ensure minimum delay
            delay = Math.max(delay, 3);

            await sleep(delay);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        // After typing, apply proper formatting
        containerEl.innerHTML = html;
    }

    // ---------- Event Listeners ----------
    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            sendMessage();
        }
    });

    // ---------- Helper Functions ----------
    function addMessage(msg, sender) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender === "user" ? "user-msg" : "bot-msg"}`;
        messageDiv.innerHTML = formatResponse(msg);
        
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
        return messageDiv; // Return the div for further manipulation
    }

    function showTyping() {
        // Create and show typing indicator
        if (!document.querySelector('.typing-indicator')) {
            const typingDiv = document.createElement("div");
            typingDiv.className = "message bot-msg typing-indicator";
            typingDiv.style.fontStyle = "italic";
            typingDiv.style.fontSize = "0.85rem";
            typingDiv.style.display = "flex";
            typingDiv.style.alignItems = "center";
            typingDiv.style.gap = "4px";
            typingDiv.innerHTML = `<span>ü§ñ Assistant is typing</span><span class="dot"></span><span class="dot"></span><span class="dot"></span>`;
            
            chatBox.appendChild(typingDiv);
        }
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function hideTyping() {
        const typingIndicator = document.querySelector('.typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    function showToast(message, type = "success") {
        toast.textContent = message;
        toast.className = `toast ${type} show`;
        toast.style.display = "block";
        toast.style.opacity = "1";
        toast.style.transform = "translateY(0)";
        
        setTimeout(() => {
            toast.style.opacity = "0";
            toast.style.transform = "translateY(-20px)";
            setTimeout(() => {
                toast.style.display = "none";
                toast.className = "toast";
            }, 300);
        }, 3000);
    }

    // ---------- Contact Form Handling ----------
    const contactModal = document.getElementById("contactModal");
    const contactSubmitBtn = document.getElementById("contactSubmit");
    const contactSkipBtn = document.getElementById("contactSkip");
    const modalCloseBtn = document.querySelector(".modal-close");

    function showContactModal() {
        contactModal.style.display = "flex";
        contactModal.setAttribute("aria-hidden", "false");
    }

    function hideContactModal() {
        contactModal.style.display = "none";
        contactModal.setAttribute("aria-hidden", "true");
    }

    // Close modal events
    modalCloseBtn.addEventListener("click", hideContactModal);
    contactSkipBtn.addEventListener("click", hideContactModal);

    // Ensure no conflicting handlers
    contactSubmitBtn.onclick = null;
    
    // Add submit button event with debugging
    contactSubmitBtn.addEventListener("click", async (event) => {
        event.preventDefault(); // Prevent any default form submission
        event.stopPropagation(); // Stop event bubbling
        
        console.log('Submit button clicked!');
        
        // Get form values with debugging
        const fname = document.getElementById("fname").value.trim();
        const lname = document.getElementById("lname").value.trim();
        const email = document.getElementById("email").value.trim();
        const phone = document.getElementById("phone").value.trim();
        
        console.log('Form values:', { fname, lname, email, phone });
        
        const formData = {
            fname: fname,
            lname: lname,
            email: email,
            phone_number: phone,
            metadata: {
                session_id: currentSessionId,
                source: "simple_chat_widget",
                firm_id: DEFAULT_PARAMS.firm_id,
                user_id: DEFAULT_PARAMS.user_id,
                timestamp: new Date().toISOString()
            }
        };

        console.log('Sending contact data:', formData);

        // Validate required fields
        if (!formData.fname || !formData.email) {
            showToast("Please fill in required fields (Name and Email)", "error");
            console.log('Validation failed: missing fname or email');
            return;
        }

        // Basic email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(formData.email)) {
            showToast("Please enter a valid email address", "error");
            console.log('Validation failed: invalid email format');
            return;
        }

        // Disable submit button to prevent double submission
        contactSubmitBtn.disabled = true;
        contactSubmitBtn.textContent = "Submitting...";

        try {
            console.log('Sending request to /save-contact...');
            
            const response = await fetch("/save-contact", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(formData)
            });

            console.log('Response status:', response.status);
            
            const result = await response.json();
            console.log('Contact save response:', result);

            if (response.ok && result.status === "ok") {
                showToast("Contact information saved successfully!", "success");
                hideContactModal();
                
                // Clear form
                document.getElementById("fname").value = "";
                document.getElementById("lname").value = "";
                document.getElementById("email").value = "";
                document.getElementById("phone").value = "";
                
                console.log('Contact saved successfully with ID:', result.id);
            } else {
                showToast(`Failed to save contact: ${result.detail || result.message || 'Unknown error'}`, "error");
                console.error('Save failed:', result);
            }
        } catch (error) {
            console.error("Error saving contact:", error);
            showToast("Error saving contact information", "error");
        } finally {
            // Re-enable submit button
            contactSubmitBtn.disabled = false;
            contactSubmitBtn.textContent = "Submit";
        }
    });

    // Click outside modal to close
    window.addEventListener("click", (e) => {
        if (e.target === contactModal) {
            hideContactModal();
        }
    });

    console.log("Simple chat interface initialized with default parameters:", DEFAULT_PARAMS);
    console.log("Current session ID:", currentSessionId);
    console.log("Session stored in localStorage for continuity");
    
    // Initialize session status on load
    updateSessionStatus();
});
</script>
</body>
</html>