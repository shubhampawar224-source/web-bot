<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üé§ Voice Assistant</title>
<style>
  body {
    background: #0f0f0f;
    color: #fff;
    font-family: 'Inter', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
  }

  #micBtn {
    background: linear-gradient(145deg,#ff7f50,#ff4500);
    border: none;
    border-radius: 50%;
    width: 120px;
    height: 120px;
    cursor: pointer;
    box-shadow: 0 0 30px #ff7f50;
    font-size: 3rem;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  #micBtn.recording {
    background: linear-gradient(145deg,#ff4500,#ff6347);
    box-shadow: 0 0 50px #ff6347;
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 30px #ff6347; }
    50% { transform: scale(1.1); box-shadow: 0 0 60px #ff6347; }
    100% { transform: scale(1); box-shadow: 0 0 30px #ff6347; }
  }

  #waveform {
    width: 300px;
    height: 60px;
    margin-top: 40px;
    display: flex;
    align-items: flex-end;
    justify-content: center;
  }
  .bar {
    width: 5px;
    margin: 0 2px;
    background: linear-gradient(to top,#ffa500,#ff4500);
    animation: wave 0.5s infinite alternate;
  }
  @keyframes wave {
    0% { height: 10px; }
    50% { height: 40px; }
    100% { height: 10px; }
  }

  #status { margin-top: 20px; font-size: 1.2rem; color: #ff7f50; }

  #botSpeaking {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(145deg,#ffd700,#ff8c00);
    margin-top: 30px;
    opacity: 0;
    transition: all 0.3s ease;
    box-shadow: 0 0 20px #ff8c00;
  }
  #botSpeaking.active {
    opacity: 1;
    animation: bounce 0.8s infinite alternate;
  }
  @keyframes bounce {
    0% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
    100% { transform: translateY(0); }
  }

  .controls {
    display: flex;
    gap: 18px;
    margin: 30px 0 10px 0;
    align-items: center;
    justify-content: center;
  }

  .ctrl-btn {
    background: #232323;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 2rem;
    color: #fff;
    box-shadow: 0 2px 10px #111;
    cursor: pointer;
    transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    outline: none;
    position: relative;
  }

  .ctrl-btn.pause { background: linear-gradient(145deg,#ffb347,#ffcc33); }
  .ctrl-btn.resume { background: linear-gradient(145deg,#7fff7f,#32cd32); }
  .ctrl-btn.stop { background: linear-gradient(145deg,#ff4e50,#f9d423); }

  .ctrl-btn:hover, #micBtn:hover {
    transform: scale(1.08);
    box-shadow: 0 4px 20px #ff7f50;
    filter: brightness(1.1);
  }
</style>
</head>
<body>
  <div class="controls">
    <button id="micBtn" title="Start/Stop Recording"><span>üéôÔ∏è</span></button>
    <button id="pauseBtn" class="ctrl-btn pause" title="Pause"><span>‚è∏Ô∏è</span></button>
    <button id="resumeBtn" class="ctrl-btn resume" style="display:none;" title="Resume"><span>‚ñ∂Ô∏è</span></button>
    <button id="stopBtn" class="ctrl-btn stop" title="Stop"><span>‚èπÔ∏è</span></button>
  </div>
  <div id="status">Click mic to start</div>
  <div id="waveform"></div>
  <div id="botSpeaking"></div>
  <audio id="botAudio" autoplay></audio>

<script>
const micBtn = document.getElementById("micBtn");
const statusEl = document.getElementById("status");
const botAudio = document.getElementById("botAudio");
const botSpeaking = document.getElementById("botSpeaking");
const waveform = document.getElementById("waveform");

let ws, mediaRecorder, audioChunks = [], animationInterval;

// Create waveform bars
for(let i=0;i<20;i++){
  const bar = document.createElement("div");
  bar.classList.add("bar");
  waveform.appendChild(bar);
}

function animateWave() {
  const bars = document.querySelectorAll(".bar");
  bars.forEach(bar => {
    bar.style.height = `${10 + Math.random()*40}px`;
  });
}

// ----------------------
// Voice recording with silence detection
// ----------------------
async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const audioContext = new AudioContext();
        const source = audioContext.createMediaStreamSource(stream);
        const processor = audioContext.createScriptProcessor(2048, 1, 1);
        source.connect(processor);
        processor.connect(audioContext.destination);

        let hasSound = false;
        const dBThreshold = -50; // Adjust this threshold

        processor.onaudioprocess = (e) => {
            const input = e.inputBuffer.getChannelData(0);
            const rms = Math.sqrt(input.reduce((sum, v) => sum + v*v, 0) / input.length);
            const dB = 20 * Math.log10(rms + 1e-8); // avoid log(0)
            if (dB > dBThreshold) hasSound = true;
        };

        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });

            if (!hasSound || audioBlob.size < 2000) {
                ws.send(JSON.stringify({ silence: true }));
                console.log("üõë Silence detected, not sending audio");
            } else {
                const arrayBuffer = await audioBlob.arrayBuffer();
                const base64Audio = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
                ws.send(JSON.stringify({ audio: base64Audio }));
            }

            hasSound = false;
        };

        mediaRecorder.start();
        statusEl.textContent = "Listening...";
        setTimeout(() => mediaRecorder.stop(), 5000); // 8-second snippet

    } catch (err) {
        console.error("Microphone access error:", err);
        statusEl.textContent = "Microphone error!";
    }
}

// ----------------------
// Mic button + WebSocket
// ----------------------
micBtn.onclick = async () => {
    micBtn.disabled = true;
    micBtn.classList.add('recording');
    statusEl.textContent = "Connecting...";

    ws = new WebSocket(`ws://${window.location.host}/ws/voice`);

    ws.onopen = () => {
        statusEl.textContent = "Listening...";
        startRecording();
        animationInterval = setInterval(animateWave, 100);
    };

    ws.onmessage = async (event) => {
        const data = JSON.parse(event.data);

        if (data.audio) {
            clearInterval(animationInterval);
            botSpeaking.classList.add("active");

            const audioBlob = new Blob(
              [Uint8Array.from(atob(data.audio), c=>c.charCodeAt(0))],
              { type:'audio/wav' }
            );
            botAudio.src = URL.createObjectURL(audioBlob);
            botAudio.play();

            botAudio.onended = () => {
                botSpeaking.classList.remove("active");
                statusEl.textContent = "Listening...";
                startRecording();
                animationInterval = setInterval(animateWave, 100);
            };
        }
    };

    ws.onclose = () => {
        micBtn.classList.remove('recording');
        micBtn.disabled = false;
        statusEl.textContent = "Connection closed.";
        clearInterval(animationInterval);
    };
};

// ----------------------
// Pause / Resume / Stop
// ----------------------
const pauseBtn = document.getElementById("pauseBtn");
const resumeBtn = document.getElementById("resumeBtn");
const stopBtn = document.getElementById("stopBtn");
let isPaused = false;

pauseBtn.onclick = () => {
    if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.pause();
        isPaused = true;
        pauseBtn.style.display = "none";
        resumeBtn.style.display = "";
        statusEl.textContent = "Paused";
        if (ws && ws.readyState === 1) ws.send(JSON.stringify({ pause: true }));
    }
};

resumeBtn.onclick = () => {
    if (mediaRecorder && mediaRecorder.state === "paused") {
        mediaRecorder.resume();
        isPaused = false;
        pauseBtn.style.display = "";
        resumeBtn.style.display = "none";
        statusEl.textContent = "Listening...";
        if (ws && ws.readyState === 1) ws.send(JSON.stringify({ resume: true }));
    }
};

stopBtn.onclick = () => {
    if (mediaRecorder && (mediaRecorder.state === "recording" || mediaRecorder.state === "paused")) {
        mediaRecorder.stop();
        statusEl.textContent = "Call stopped.";
    }
    if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ stop: true }));
        ws.close();
    }
    micBtn.disabled = false;
    pauseBtn.style.display = "";
    resumeBtn.style.display = "none";
};
</script>
</body>
</html>
