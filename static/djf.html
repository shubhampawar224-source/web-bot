<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple Chat Assistant</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Roboto:wght@300;400;500&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="./css/style.css">
  <link rel="stylesheet" href="./css/popup.css">
  <!-- Fallback CSS paths -->
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="stylesheet" href="/static/css/popup.css">
  <style>
    /* Additional CSS to ensure proper rendering */
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow-x: hidden;
    }

    /* Force proper box-sizing */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body {
      background-color: #f5f6fa !important;
    }

    /* Hide sidebar and navbar completely */
    .sidebar-toggle,
    .left-sidebar,
    .navbar {
      display: none !important;
    }

    /* Ensure chat container works properly without navbar */
    .chat-container,
    #chat-container {
      position: fixed !important;
      top: 20px !important;
      right: 20px !important;
      bottom: 20px !important;
      width: 450px;
      height: calc(100vh - 40px) !important;
      max-width: calc(100vw - 40px) !important;
      max-height: calc(100vh - 40px) !important;
    }

    /* Toast styling override */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      min-width: 220px;
      max-width: 400px;
      background-color: #2ecc71;
      color: white;
      padding: 12px 18px;
      border-radius: 8px;
      font-weight: 500;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s ease;
      z-index: 9999;
      word-wrap: break-word;
      line-height: 1.4;
      display: none;
    }

    .toast.error {
      background-color: #e74c3c;
    }

    .toast.success {
      background-color: #2ecc71;
    }

    /* Responsive for mobile */
    @media (max-width: 600px) {

      .chat-container,
      #chat-container {
        width: calc(100vw - 20px) !important;
        right: 10px !important;
        left: 10px !important;
        height: calc(100vh - 30px) !important;
        top: 10px !important;
      }
    }

    /* Enhanced Message Formatting */
    .numbered-item {
      margin: 4px 0;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      line-height: 1.25;
    }

    .numbered-item .number {
      font-weight: 600;
      color: #4a90e2;
      min-width: 24px;
      flex-shrink: 0;
    }

    .numbered-item .number-content {
      flex: 1 1 auto;
      color: #0b1320;
      white-space: normal;
      word-break: break-word;
    }

    .bullet-item {
      margin: 6px 0;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      line-height: 1.6;
    }

    .bullet-item .bullet {
      color: #4a90e2;
      font-weight: bold;
      min-width: 16px;
      flex-shrink: 0;
    }

    .bullet-item .bullet-content {
      flex: 1 1 auto;
      color: #0b1320;
      white-space: normal;
      word-break: break-word;
    }

    /* Ensure links inside messages and list content stay inline and wrap naturally */
    .message a,
    .numbered-item .number-content a,
    .bullet-item .bullet-content a {
      color: #1e66b3;
      text-decoration: underline;
      display: inline;
      white-space: normal;
      word-break: break-word;
    }

    /* Slightly reduce message padding to compact the chat look */
    .message {
      padding: 8px 12px;
    }

    /* Enhanced Typing Indicator */
    .typing-indicator {
      background-color: #f0f8ff !important;
      border-left: 3px solid #4a90e2 !important;
      animation: fadeInTyping 0.3s ease-in !important;
    }

    .typing-indicator .dot {
      width: 6px !important;
      height: 6px !important;
      background-color: #4a90e2 !important;
      border-radius: 50% !important;
      animation: typingDots 1.4s infinite ease-in-out !important;
      margin: 0 1px !important;
    }

    .typing-indicator .dot:nth-child(2) {
      animation-delay: 0.2s !important;
    }

    .typing-indicator .dot:nth-child(3) {
      animation-delay: 0.4s !important;
    }

    .typing-indicator .dot:nth-child(4) {
      animation-delay: 0.6s !important;
    }

    @keyframes fadeInTyping {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes typingDots {

      0%,
      60%,
      100% {
        opacity: 0.3;
        transform: scale(0.8);
      }

      30% {
        opacity: 1;
        transform: scale(1.2);
      }
    }

    /* Message content formatting */
    .message {
      line-height: 1.25;
      /* tighter overall line height for messages */
      font-size: 14px;
    }

    .message p {
      margin: 0 0 6px 0;
      /* reduced bottom margin */
      line-height: 1.25;
      /* compact spacing */
    }

    .message p:last-child {
      margin-bottom: 0;
    }

    .message br {
      line-height: 1.8;
    }

    /* Session Controls */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .session-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .session-id {
      font-size: 14px;
      opacity: 0.8;
    }

    .new-chat-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    .new-chat-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Session Status */
    .session-status {
      font-size: 11px;
      color: #666;
      text-align: center;
      padding: 4px 0;
      border-bottom: 1px solid #eee;
      background: #f9f9f9;
    }

    /* Contact Form Button Fixes */
    #contactSubmit {
      background-color: #4a90e2 !important;
      color: white !important;
      border: none !important;
      padding: 10px 20px !important;
      border-radius: 5px !important;
      cursor: pointer !important;
      font-size: 14px !important;
      transition: background-color 0.3s !important;
      min-width: 80px !important;
    }

    #contactSubmit:hover {
      background-color: #357abd !important;
    }

    #contactSubmit:disabled {
      background-color: #ccc !important;
      cursor: not-allowed !important;
    }

    /* Ensure modal is above iframe content */
    #contactModal {
      position: fixed !important;
      z-index: 10000 !important;
    }

    html,
    body {
      background: transparent;
    }

    /* Embedded iframe support: make page background transparent when embedded */
    html.embedded-iframe,
    body.embedded-iframe {
      background-color: transparent !important;
    }

    /* Chat popup theming to match site background (blue header like screenshot) */
    #chat-container {
      display: none;
      /* toggled by JS */
      flex-direction: column;
      background: #ffffff;
      /* body of the popup (keeps messages readable)	*/
      border-radius: 12px;
      box-shadow: 0 18px 40px rgba(2, 6, 23, 0.28);
      overflow: hidden;
      z-index: 9998;
      min-height: 420px;
      max-height: calc(100vh - 80px);
    }

    /* Header with blue gradient to match the site's blue background */
    #chat-container .header {
      background: linear-gradient(180deg, #2b86d6 0%, #1e66b3 100%);
      color: #ffffff;
      padding: 14px 16px;
      font-weight: 600;
      font-size: 16px;
      align-items: center;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    /* Chat messages area */
    #chat-box {
      padding: 14px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 1) 0%, rgba(250, 252, 255, 1) 100%);
      overflow: auto;
      flex: 1 1 auto;
    }

    /* Input area */
    .chat-input {
      display: flex;
      gap: 8px;
      padding: 12px;
      background: #f6f8fb;
      border-top: 1px solid #e6e9ef;
      align-items: center;
    }

    .chat-input input[type="text"] {
      flex: 1 1 auto;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #e0e6ef;
      outline: none;
      font-size: 14px;
      background: #fff;
    }

    .chat-input #send-btn {
      background: linear-gradient(180deg, #2b86d6, #1e66b3);
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    /* Floating chat icon (tan/gold circular button like provided image) */
    .chat-icon {
      position: fixed;
      right: 24px;
      bottom: 24px;
      width: 72px;
      height: 72px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #e0a86a;
      /* warm tan/gold */
      color: #fff;
      border-radius: 50%;
      box-shadow: 0 12px 30px rgba(12, 20, 30, 0.28);
      cursor: pointer;
      z-index: 10000;
      font-size: 20px;
      transition: transform 180ms ease, box-shadow 180ms ease;
      border: 3px solid rgba(255, 255, 255, 0.06);
    }

    .chat-icon:hover {
      transform: translateY(-4px);
      box-shadow: 0 18px 36px rgba(12, 20, 30, 0.34);
    }

    .chat-icon svg {
      width: 36px;
      height: 36px;
      display: block;
    }

    /* small close button in header */
    .chat-close-btn {
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.95);
      font-size: 18px;
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
    }

    .chat-close-btn:hover {
      background: rgba(255, 255, 255, 0.06);
    }
  </style>
</head>

<body>

  <!-- Chat Icon -->
  <div class="chat-icon" id="chat-icon" role="button" aria-label="Open chat" title="Chat">
    <!-- Inline SVG: two overlapping chat bubbles with three dots -->
    <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
      <g fill="none" fill-rule="evenodd">
        <path fill="#fff" d="M46 10H14a6 6 0 0 0-6 6v18l8-4h30a6 6 0 0 0 6-6V16a6 6 0 0 0-6-6z" />
        <path fill="#fff" d="M20 36h-4a6 6 0 0 0-6 6v6l6-2h4a6 6 0 0 0 6-6v-2a6 6 0 0 0-6-6z" />
        <circle cx="28" cy="23" r="2.5" fill="#fff" />
        <circle cx="34" cy="23" r="2.5" fill="#fff" />
        <circle cx="31" cy="23" r="2.5" fill="#fff" />
      </g>
    </svg>
  </div>

  <!-- Chat Container -->
  <div class="chat-container" id="chat-container">
    <div class="header">
      <div class="header-left">Chat Assistant</div>
      <div class="session-controls">
        <!-- <span class="session-id" title="Session ID">üí¨</span>
        <button class="new-chat-btn" onclick="startNewChat()" title="Start New Conversation">üîÑ</button> -->
        <button class="new-chat-btn" onclick="testContactForm()" title="Test Contact Form">üìã</button>
        <button id="chat-close-btn" class="chat-close-btn" title="Close chat" aria-label="Close chat">‚úï</button>
      </div>
    </div>

    <div id="chat-box"></div>

    <!-- Typing indicator inside chat box -->
    <div id="chat-loader" class="chat-typing" style="display:none">
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </div>

    <div class="chat-input">
      <input type="text" id="user-input" placeholder="Ask anything...">
      <button id="send-btn">Send</button>
    </div>
  </div>

  <!-- Contact Form Modal -->
  <div id="contactModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="contactTitle">
      <div class="modal-header">
        <h2 id="contactTitle">Provide Your Contact Details</h2>
        <button class="modal-close" aria-label="Close">&times;</button>
      </div>

      <div class="modal-form">
        <div class="grid-2">
          <div>
            <label for="fname">First Name</label>
            <input type="text" id="fname" placeholder="First Name">
          </div>
          <div>
            <label for="lname">Last Name</label>
            <input type="text" id="lname" placeholder="Last Name">
          </div>
        </div>

        <label for="email">Email</label>
        <input type="email" id="email" placeholder="Email">

        <label for="phone">Phone Number</label>
        <input type="text" id="phone" placeholder="Phone Number">

        <div class="modal-actions">
          <button id="contactSkip" class="btn secondary">Skip</button>
          <button id="contactSubmit" class="btn primary">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Contact form is handled by inline JavaScript below -->
  <!-- <script src="./js/popup.js"></script> -->
  <!-- <script src="/static/js/popup.js"></script> -->

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ---------- Default Parameters ----------
      const DEFAULT_PARAMS = {
        firm_id: "2", // Changed to string format as requested
        url_ids: "2",
        user_id: "1"
      };

      // If embedded in an iframe (or if URL has embed param), make body background transparent
      (function setEmbeddedBackground() {
        try {
          const params = new URLSearchParams(window.location.search || '');
          const embedParam = params.get('embed') || params.get('iframe') || params.get('widget');
          const inIframe = (window.self !== window.top) || !!embedParam;
          if (inIframe) {
            document.body.classList.add('embedded-iframe');
            try { document.documentElement.classList.add('embedded-iframe'); } catch (e) { }
          }
        } catch (e) {
          // ignore
        }
      })();

      // Cross-browser UUID generator
      function getUUID() {
        try {
          if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') return crypto.randomUUID();
        } catch (e) { }
        try {
          if (typeof crypto !== 'undefined' && typeof crypto.getRandomValues === 'function') {
            const arr = new Uint8Array(16);
            crypto.getRandomValues(arr);
            arr[6] = (arr[6] & 0x0f) | 0x40;
            arr[8] = (arr[8] & 0x3f) | 0x80;
            const hex = Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
            return `${hex.substr(0, 8)}-${hex.substr(8, 4)}-${hex.substr(12, 4)}-${hex.substr(16, 4)}-${hex.substr(20, 12)}`;
          }
        } catch (e) { }
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) { const r = Math.random() * 16 | 0; const v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); });
      }

      // ---------- Session Management ----------
      let currentSessionId = localStorage.getItem('chat_session_id');
      let isRestoredSession = false;

      // If no existing session, create a new one
      if (!currentSessionId) {
        currentSessionId = getUUID();
        localStorage.setItem('chat_session_id', currentSessionId);
        console.log('New session created:', currentSessionId);
      } else {
        isRestoredSession = true;
        console.log('Session restored:', currentSessionId);
      }

      // Function to reset session if needed
      function resetChatSession() {
        currentSessionId = getUUID();
        localStorage.setItem('chat_session_id', currentSessionId);
        console.log('New chat session started:', currentSessionId);
      }

      // Global function for new chat button
      window.startNewChat = function () {
        if (confirm('Start a new conversation? This will clear the current chat history.')) {
          resetChatSession();
          chatBox.innerHTML = '';
          greeted = false;
          addMessage("Hello! I'm your assistant. How can I help you today?", "bot");
          updateSessionStatus();
        }
      }

      // Global function to test contact form
      window.testContactForm = function () {
        console.log('Testing contact form...');
        showContactModal();
      }

      function updateSessionStatus() {
        const sessionElement = document.querySelector('.session-id');
        if (sessionElement) {
          sessionElement.title = `Session: ${currentSessionId.substring(0, 8)}...`;
        }
      }

      // ---------- DOM Elements ----------
      const chatIcon = document.getElementById("chat-icon");
      const chatContainer = document.getElementById("chat-container");
      const chatBox = document.getElementById("chat-box");
      const userInput = document.getElementById("user-input");
      const sendBtn = document.getElementById("send-btn");
      const toast = document.getElementById("toast");
      const chatLoader = document.getElementById("chat-loader");

      let greeted = false;

      // ---------- Chat Icon Toggle ----------
      chatIcon.addEventListener("click", () => {
        const isVisible = chatContainer.style.display === "flex";
        chatContainer.style.display = isVisible ? "none" : "flex";

        // hide/show floating icon depending on new state
        chatIcon.style.display = isVisible ? "flex" : "none";

        if (!isVisible && !greeted) {
          setTimeout(() => {
            if (isRestoredSession) {
              addMessage("Welcome back! I'm continuing our conversation. How can I help you?", "bot");
            } else {
              addMessage("Hello! I'm your assistant. How can I help you today?", "bot");
            }
            greeted = true;
            updateSessionStatus();
          }, 500);
        }
      });

      // Close button in header should hide popup and show floating icon again
      const chatCloseBtn = document.getElementById('chat-close-btn');
      if (chatCloseBtn) {
        chatCloseBtn.addEventListener('click', () => {
          chatContainer.style.display = 'none';
          chatIcon.style.display = 'flex';
        });
      }

      // ---------- Send Message Function ----------
      async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        // Add user message
        addMessage(message, "user");
        userInput.value = "";

        // Show typing indicator
        showTyping();

        try {
          // Send to backend with default parameters
          const payload = {
            ...DEFAULT_PARAMS,
            session_id: currentSessionId,
            query: message
          };

          console.log('Sending payload:', payload);

          const response = await fetch("/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log('Received response:', data);

          // Hide typing indicator
          hideTyping();

          // Add bot response using proper response handling
          if (data && (data.response || data.answer)) {
            const responseText = data.response || data.answer;
            await handleBotResponse(responseText);
          } else if (data.error) {
            addMessage(`Sorry, I encountered an error: ${data.error}`, "bot");
          } else {
            addMessage("‚ö†Ô∏è No valid response from assistant.", "bot");
          }

        } catch (error) {
          console.error("Error sending message:", error);
          hideTyping();
          addMessage("‚ö†Ô∏è Network error or backend issue occurred.", "bot");
        }
      }

      // ---------- Response Handling Functions (Enhanced) ----------
      function formatResponse(resp) {
        if (!resp) return "";

        let formatted = String(resp || "");

        // Handle numbered lists (1. 2. 3. etc.)
        // Wrap list text in a dedicated content container so flex layout works reliably
        formatted = formatted.replace(/^(\d+)\.\s+(.+)$/gm, '<div class="numbered-item"><span class="number">$1.</span><div class="number-content">$2</div></div>');

        // Handle bullet points
        formatted = formatted.replace(/^[‚Ä¢\-\*]\s+(.+)$/gm, '<div class="bullet-item"><span class="bullet">‚Ä¢</span><div class="bullet-content">$1</div></div>');

        // Handle line breaks for better readability
        formatted = formatted.replace(/\n\n/g, '</p><p>');
        formatted = formatted.replace(/\n/g, '<br>');

        // Wrap in paragraph if not already formatted
        if (!formatted.includes('<div class="numbered-item">') && !formatted.includes('<div class="bullet-item">')) {
          formatted = '<p>' + formatted + '</p>';
        }

        // Parse markdown-style links
        return parseMarkdownLinks(formatted);
      }

      function parseMarkdownLinks(text) {
        if (!text) return "";

        // Convert [text](url) to HTML links
        return text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
      }

      async function handleBotResponse(responseText) {
        let consumed = false;

        // Try to parse structured JSON response
        try {
          let parsed = typeof responseText === "string" ? JSON.parse(responseText) : responseText;
          if (parsed && parsed.action === "SHOW_CONTACT_FORM") {
            const botMsgDiv = addMessage("", "bot");
            const assistantText = parsed.message || "Before we finish, please share your contact details.";
            await typeMessage(botMsgDiv, assistantText, 3);

            // Open contact modal with delay
            setTimeout(() => {
              showContactModal();
            }, 2000);

            consumed = true;
          }
        } catch (e) {
          // Not JSON or parsing failed -> treat as regular text
          consumed = false;
        }

        if (!consumed) {
          const botMsgDiv = addMessage("", "bot");
          await typeMessage(botMsgDiv, responseText, 3);
        }
      }

      async function typeMessage(containerEl, resp, speed = 2) {
        const html = formatResponse(resp);

        // If HTML contains complex tags (lists/numbered items), show immediately
        if (/<div class="(numbered-item|bullet-item)"/.test(html) || /<\/?[a-z][\s\S]*>/i.test(html)) {
          containerEl.innerHTML = html;
          // Add a small delay to simulate loading
          await new Promise(r => setTimeout(r, 300));
          return;
        }

        // Natural typing simulation for simple text
        const baseDelay = 8; // Faster baseline for better UX
        const jitterFactor = 0.3; // Less randomness

        const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

        containerEl.innerHTML = "";
        const plainText = html.replace(/<[^>]*>/g, ''); // Strip HTML for typing

        for (let i = 0; i < plainText.length; i++) {
          const ch = plainText.charAt(i);
          containerEl.textContent += ch;

          // Determine delay
          let delay = baseDelay * (speed || 1);

          // Shorter pause for spaces
          if (ch === " ") {
            delay *= 0.5;
          }

          // Longer pause for punctuation
          if (/[.!?]/.test(ch)) {
            delay += baseDelay * 8;
          } else if (/[,;:]/.test(ch)) {
            delay += baseDelay * 4;
          }

          // Add slight randomness
          delay += (Math.random() - 0.5) * baseDelay * jitterFactor;

          // Ensure minimum delay
          delay = Math.max(delay, 3);

          await sleep(delay);
          chatBox.scrollTop = chatBox.scrollHeight;
        }

        // After typing, apply proper formatting
        containerEl.innerHTML = html;
      }

      // ---------- Event Listeners ----------
      sendBtn.addEventListener("click", sendMessage);
      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          sendMessage();
        }
      });

      // ---------- Helper Functions ----------
      function addMessage(msg, sender) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender === "user" ? "user-msg" : "bot-msg"}`;
        messageDiv.innerHTML = formatResponse(msg);

        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
        return messageDiv; // Return the div for further manipulation
      }

      function showTyping() {
        // Create and show typing indicator
        if (!document.querySelector('.typing-indicator')) {
          const typingDiv = document.createElement("div");
          typingDiv.className = "message bot-msg typing-indicator";
          typingDiv.style.fontStyle = "italic";
          typingDiv.style.fontSize = "0.85rem";
          typingDiv.style.display = "flex";
          typingDiv.style.alignItems = "center";
          typingDiv.style.gap = "4px";
          typingDiv.innerHTML = `<span>ü§ñ Assistant is typing</span><span class="dot"></span><span class="dot"></span><span class="dot"></span>`;

          chatBox.appendChild(typingDiv);
        }
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function hideTyping() {
        const typingIndicator = document.querySelector('.typing-indicator');
        if (typingIndicator) {
          typingIndicator.remove();
        }
      }

      function showToast(message, type = "success") {
        toast.textContent = message;
        toast.className = `toast ${type} show`;
        toast.style.display = "block";
        toast.style.opacity = "1";
        toast.style.transform = "translateY(0)";

        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transform = "translateY(-20px)";
          setTimeout(() => {
            toast.style.display = "none";
            toast.className = "toast";
          }, 300);
        }, 3000);
      }

      // ---------- Contact Form Handling ----------
      const contactModal = document.getElementById("contactModal");
      const contactSubmitBtn = document.getElementById("contactSubmit");
      const contactSkipBtn = document.getElementById("contactSkip");
      const modalCloseBtn = document.querySelector(".modal-close");

      function showContactModal() {
        contactModal.style.display = "flex";
        contactModal.setAttribute("aria-hidden", "false");
      }

      function hideContactModal() {
        contactModal.style.display = "none";
        contactModal.setAttribute("aria-hidden", "true");
      }

      // Close modal events
      modalCloseBtn.addEventListener("click", hideContactModal);
      contactSkipBtn.addEventListener("click", hideContactModal);

      // Ensure no conflicting handlers
      contactSubmitBtn.onclick = null;

      // Add submit button event with debugging
      contactSubmitBtn.addEventListener("click", async (event) => {
        event.preventDefault(); // Prevent any default form submission
        event.stopPropagation(); // Stop event bubbling

        console.log('Submit button clicked!');

        // Get form values with debugging
        const fname = document.getElementById("fname").value.trim();
        const lname = document.getElementById("lname").value.trim();
        const email = document.getElementById("email").value.trim();
        const phone = document.getElementById("phone").value.trim();

        console.log('Form values:', { fname, lname, email, phone });

        const formData = {
          fname: fname,
          lname: lname,
          email: email,
          phone_number: phone,
          metadata: {
            session_id: currentSessionId,
            source: "simple_chat_widget",
            firm_id: DEFAULT_PARAMS.firm_id,
            user_id: DEFAULT_PARAMS.user_id,
            timestamp: new Date().toISOString()
          }
        };

        console.log('Sending contact data:', formData);

        // Validate required fields
        if (!formData.fname || !formData.email) {
          showToast("Please fill in required fields (Name and Email)", "error");
          console.log('Validation failed: missing fname or email');
          return;
        }

        // Basic email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(formData.email)) {
          showToast("Please enter a valid email address", "error");
          console.log('Validation failed: invalid email format');
          return;
        }

        // Disable submit button to prevent double submission
        contactSubmitBtn.disabled = true;
        contactSubmitBtn.textContent = "Submitting...";

        try {
          console.log('Sending request to /save-contact...');

          const response = await fetch("/save-contact", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData)
          });

          console.log('Response status:', response.status);

          const result = await response.json();
          console.log('Contact save response:', result);

          if (response.ok && result.status === "ok") {
            showToast("Contact information saved successfully!", "success");
            hideContactModal();

            // Clear form
            document.getElementById("fname").value = "";
            document.getElementById("lname").value = "";
            document.getElementById("email").value = "";
            document.getElementById("phone").value = "";

            console.log('Contact saved successfully with ID:', result.id);
          } else {
            showToast(`Failed to save contact: ${result.detail || result.message || 'Unknown error'}`, "error");
            console.error('Save failed:', result);
          }
        } catch (error) {
          console.error("Error saving contact:", error);
          showToast("Error saving contact information", "error");
        } finally {
          // Re-enable submit button
          contactSubmitBtn.disabled = false;
          contactSubmitBtn.textContent = "Submit";
        }
      });

      // Click outside modal to close
      window.addEventListener("click", (e) => {
        if (e.target === contactModal) {
          hideContactModal();
        }
      });

      console.log("Simple chat interface initialized with default parameters:", DEFAULT_PARAMS);
      console.log("Current session ID:", currentSessionId);
      console.log("Session stored in localStorage for continuity");

      // Initialize session status on load
      updateSessionStatus();
    });
  </script>
</body>

</html>