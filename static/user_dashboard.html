<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - KitKool</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .dashboard-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #3b82f6;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-name {
            font-weight: 500;
            color: #374151;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .main-content {
            padding: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            color: #374151;
            margin-bottom: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.75rem;
        }

        .url-injection-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 1.25rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #374151;
        }

        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }

        .btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-widget {
            background: #10b981;
        }

        .btn-widget:hover {
            background: #059669;
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn:disabled:hover {
            background: #9ca3af;
            transform: none;
        }

        .url-controls {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .control-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .select-all-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            color: #374151;
        }

        .select-all-checkbox {
            width: 18px;
            height: 18px;
        }

        .selected-count {
            color: #3b82f6;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .url-form {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            display: none;
        }

        .url-form.show {
            display: block;
        }

        .url-list {
            display: grid;
            gap: 0.75rem;
        }

        .url-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .url-info {
            flex: 1;
        }

        .url-info h4 {
            color: #374151;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.125rem;
        }

        .url-info p {
            color: #64748b;
            font-size: 0.625rem;
        }

        .url-status-container {
            text-align: center;
            min-width: 120px;
        }

        .url-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 120px;
        }

        .btn-launch {
            background: #10b981;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .btn-launch:hover {
            background: #059669;
        }

        .btn-preview {
            background: #6b7280;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .btn-preview:hover {
            background: #4b5563;
        }

        .btn-disabled {
            background: #9ca3af;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            cursor: not-allowed;
        }

        .url-status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-processing {
            background: #fef3c7;
            color: #92400e;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .url-status-container {
            text-align: right;
        }

        .status-note {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            color: #64748b;
        }

        .message {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .message.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }

        .hidden {
            display: none !important;
        }

        /* Icon size adjustments for compact design */
        .header h1 i,
        .card h3 i,
        .section-title i,
        .btn i {
            font-size: 0.875rem;
            margin-right: 0.375rem;
        }

        .status-icon {
            font-size: 1.125rem;
            color: #64748b;
        }

        .info-box i {
            color: #3b82f6;
            font-size: 1rem;
            margin-top: 0.25rem;
        }

        /* Compact form styling */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* API Key Management Styles */
        .api-key-status {
            margin-bottom: 1rem;
        }

        .status-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .status-card.has-key {
            background: #ecfdf5;
            border-color: #10b981;
        }

        .status-card.no-key {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .status-card.error {
            background: #fee2e2;
            border-color: #ef4444;
        }

        .status-icon {
            font-size: 1.5rem;
            color: #64748b;
        }

        .status-card.has-key .status-icon {
            color: #10b981;
        }

        .status-card.no-key .status-icon {
            color: #f59e0b;
        }

        .status-card.error .status-icon {
            color: #ef4444;
        }

        .status-content h4 {
            margin: 0 0 0.125rem 0;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
        }

        .status-content p {
            margin: 0;
            font-size: 0.75rem;
            color: #64748b;
        }

        .api-key-info {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .info-box {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .info-box:last-child {
            margin-bottom: 0;
        }

        .info-box i {
            color: #3b82f6;
            font-size: 1.25rem;
            margin-top: 0.25rem;
        }

        .info-box strong {
            display: block;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        .info-box p {
            color: #64748b;
            font-size: 0.875rem;
            margin: 0;
            line-height: 1.5;
        }

        .info-box a {
            color: #3b82f6;
            text-decoration: none;
        }

        .info-box a:hover {
            text-decoration: underline;
        }

        .api-key-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .api-key-input-group input {
            flex: 1;
            min-width: 0;
        }

        .btn-icon {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 0.5rem;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .form-help {
            display: block;
            color: #6b7280;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        @media (max-width: 768px) {
            .header {
                padding: 0.75rem;
                flex-direction: column;
                gap: 0.75rem;
            }

            .header h1 {
                font-size: 1.125rem;
            }

            .main-content {
                padding: 0.75rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .section-actions {
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
            }

            .section-actions .btn {
                width: 100%;
                justify-content: center;
                font-size: 0.75rem;
                padding: 0.5rem;
            }

            .section-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .url-controls {
                padding: 0.75rem;
            }

            .control-group {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }

            .url-item {
                flex-direction: column;
                gap: 0.75rem;
                align-items: stretch;
            }

            .url-select {
                order: 3;
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="header">
            <h1><i class="fas fa-robot"></i> My Chatbot Dashboard</h1>
            <div class="user-info">
                <span class="user-name" id="user-name">Loading...</span>
                <button class="logout-btn" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Stats -->
            <div class="dashboard-grid">
                <div class="card">
                    <h3><i class="fas fa-link"></i> URL Requests</h3>
                    <div class="stat-number" id="total-urls">-</div>
                    <div class="stat-label">Total submitted</div>
                </div>
                <div class="card">
                    <h3><i class="fas fa-check-circle"></i> Processed URLs</h3>
                    <div class="stat-number" id="approved-urls">-</div>
                    <div class="stat-label">Successfully processed</div>
                </div>
                <div class="card">
                    <h3><i class="fas fa-exclamation-triangle"></i> Failed URLs</h3>
                    <div class="stat-number" id="pending-urls">-</div>
                    <div class="stat-label">Processing failed</div>
                </div>
            </div>

            <!-- API Key Management Section -->
            <div class="url-injection-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-key"></i> GPT API Key Settings
                    </h2>
                    <div class="section-actions">
                        <button class="btn" id="edit-api-key-btn">
                            <i class="fas fa-edit"></i> Update API Key
                        </button>
                    </div>
                </div>

                <!-- API Key Status -->
                <div class="api-key-status" id="api-key-status">
                    <div class="status-card">
                        <div class="status-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="status-content">
                            <h4>API Key Status</h4>
                            <p id="api-key-status-text">Checking API key status...</p>
                        </div>
                    </div>
                </div>

                <!-- API Key Form -->
                <div id="api-key-form" class="url-form" style="display: none;">
                    <h3>Configure Your OpenAI GPT API Key</h3>
                    <div class="api-key-info">
                        <div class="info-box">
                            <i class="fas fa-lightbulb"></i>
                            <div>
                                <strong>Why do you need an API key?</strong>
                                <p>By providing your own OpenAI API key, you get unlimited access to the chatbot with your own GPT usage. 
                                Without an API key, you'll use our shared service which may have limitations.</p>
                            </div>
                        </div>
                        <div class="info-box">
                            <i class="fas fa-link"></i>
                            <div>
                                <strong>How to get an API key:</strong>
                                <p>1. Visit <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI API Keys</a><br>
                                2. Create a new API key<br>
                                3. Copy and paste it below</p>
                            </div>
                        </div>
                    </div>
                    
                    <form id="api-key-form-element">
                        <div class="form-group">
                            <label for="api-key-input">OpenAI API Key</label>
                            <div class="api-key-input-group">
                                <input type="password" id="api-key-input" name="api_key" required 
                                       placeholder="sk-...">
                                <button type="button" id="toggle-api-key-visibility" class="btn-icon">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" id="test-api-key" class="btn btn-secondary">
                                    <i class="fas fa-check"></i> Test Key
                                </button>
                            </div>
                            <small class="form-help">Your API key is encrypted and stored securely. We never share or misuse your key.</small>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Save API Key
                            </button>
                            <button type="button" class="btn btn-secondary" id="cancel-api-key-btn">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button type="button" class="btn btn-danger" id="remove-api-key-btn" style="display: none;">
                                <i class="fas fa-trash"></i> Remove API Key
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Success/Error Messages for API Key -->
                <div id="api-key-message" class="message"></div>
            </div>

            <!-- URL Injection Section -->
            <div class="url-injection-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-globe"></i> Manage Your Chatbot URLs
                    </h2>
                    <div class="section-actions">
                        <button class="btn" id="add-url-btn">
                            <i class="fas fa-plus"></i> Add New URL
                        </button>
                    </div>
                </div>

                <!-- Success/Error Messages -->
                <div id="message" class="message"></div>

                <!-- URL Submission Form -->
                <div id="url-form" class="url-form">
                    <h3>Add URL to Your Chatbot Knowledge Base</h3>
                    <form id="url-submission-form">
                        <div class="form-group">
                            <label for="url-input">Website URL</label>
                            <input type="url" id="url-input" name="url" required 
                                   placeholder="https://example.com">
                        </div>
                        <div class="form-group">
                            <label for="description-input">Description (Optional)</label>
                            <textarea id="description-input" name="description" rows="3"
                                      placeholder="Brief description of what this URL contains..."></textarea>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-plus"></i> Add to Chatbot
                            </button>
                            <button type="button" class="btn" id="cancel-url-btn" style="background: #6b7280;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>

                <!-- URL List -->
                <div id="url-list" class="url-list">
                    <div class="loading">Loading your URLs...</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // User Dashboard JavaScript
        class UserDashboard {
            constructor() {
                this.authToken = localStorage.getItem('user_token');
                this.userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
                this.urls = [];
                
                this.init();
            }

            init() {
                if (!this.authToken) {
                    window.location.href = '/login';
                    return;
                }

                this.bindEvents();
                this.loadUserData();
                this.loadUserUrls();
                this.loadApiKeyStatus();
            }

            bindEvents() {
                // Logout
                document.getElementById('logout-btn').addEventListener('click', () => this.logout());
                
                // URL Form
                document.getElementById('add-url-btn').addEventListener('click', () => this.showUrlForm());
                document.getElementById('cancel-url-btn').addEventListener('click', () => this.hideUrlForm());
                document.getElementById('url-submission-form').addEventListener('submit', (e) => this.submitUrl(e));
                
                // API Key Management
                document.getElementById('edit-api-key-btn').addEventListener('click', () => this.showApiKeyForm());
                document.getElementById('cancel-api-key-btn').addEventListener('click', () => this.hideApiKeyForm());
                document.getElementById('api-key-form-element').addEventListener('submit', (e) => this.submitApiKey(e));
                document.getElementById('test-api-key').addEventListener('click', () => this.testApiKey());
                document.getElementById('toggle-api-key-visibility').addEventListener('click', () => this.toggleApiKeyVisibility());
                document.getElementById('remove-api-key-btn').addEventListener('click', () => this.removeApiKey());
                
                // Make userDashboard available globally for button onclick handlers
                window.userDashboard = this;
            }

            loadUserData() {
                const userNameEl = document.getElementById('user-name');
                if (this.userInfo.full_name) {
                    userNameEl.textContent = this.userInfo.full_name;
                } else if (this.userInfo.first_name && this.userInfo.last_name) {
                    userNameEl.textContent = `${this.userInfo.first_name} ${this.userInfo.last_name}`;
                } else {
                    userNameEl.textContent = this.userInfo.email || 'User';
                }
            }

            async loadUserUrls() {
                try {
                    const response = await fetch('/user/urls', {
                        headers: {
                            'Authorization': `Bearer ${this.authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.urls = data.urls || [];
                        this.updateStats();
                        this.renderUrls();
                    } else {
                        this.showMessage('Failed to load URLs', 'error');
                    }
                } catch (error) {
                    console.error('Error loading URLs:', error);
                    this.showMessage('Error loading URLs', 'error');
                }
            }

            updateStats() {
                const totalUrls = this.urls.length;
                const completedUrls = this.urls.filter(url => url.status === 'completed').length;
                const failedUrls = this.urls.filter(url => url.status === 'failed').length;

                document.getElementById('total-urls').textContent = totalUrls;
                document.getElementById('approved-urls').textContent = completedUrls;
                document.getElementById('pending-urls').textContent = failedUrls;
            }

            renderUrls() {
                const urlList = document.getElementById('url-list');
                
                if (this.urls.length === 0) {
                    urlList.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #64748b;">
                            <i class="fas fa-globe" style="font-size: 2rem; margin-bottom: 0.75rem; opacity: 0.5;"></i>
                            <p>No URLs submitted yet. Add your first URL to get started!</p>
                        </div>
                    `;
                    return;
                }

                urlList.innerHTML = this.urls.map(url => {
                    let statusBadge = '';
                    let statusIcon = '';
                    let canLaunch = url.status === 'completed';
                    
                    switch(url.status) {
                        case 'processing':
                            statusBadge = 'status-processing';
                            statusIcon = 'fas fa-spinner fa-spin';
                            break;
                        case 'completed':
                            statusBadge = 'status-approved';
                            statusIcon = 'fas fa-check-circle';
                            break;
                        case 'failed':
                            statusBadge = 'status-rejected';
                            statusIcon = 'fas fa-times-circle';
                            break;
                        default:
                            statusBadge = 'status-processing';
                            statusIcon = 'fas fa-spinner fa-spin';
                    }
                    
                    return `
                        <div class="url-item">
                            <div class="url-info">
                                <h4>${url.url}</h4>
                                ${url.firm_name ? `<p><i class="fas fa-building"></i> <strong>${url.firm_name}</strong></p>` : ''}
                                <p><i class="fas fa-calendar"></i> Submitted: ${new Date(url.created_at).toLocaleDateString()}</p>
                                ${url.description ? `<p><i class="fas fa-info-circle"></i> ${url.description}</p>` : ''}
                                ${url.processed_at ? `<p><i class="fas fa-check"></i> Processed: ${new Date(url.processed_at).toLocaleDateString()}</p>` : ''}
                            </div>
                            <div class="url-status-container">
                                <span class="url-status ${statusBadge}">
                                    <i class="${statusIcon}"></i> ${url.status.toUpperCase()}
                                </span>
                                ${url.status === 'completed' ? '<div class="status-note">‚úÖ Ready for chatbot</div>' : ''}
                                ${url.status === 'failed' ? '<div class="status-note">‚ùå Processing failed</div>' : ''}
                                ${url.status === 'processing' ? '<div class="status-note">‚ö° Processing...</div>' : ''}
                            </div>
                            <div class="url-actions">
                                ${canLaunch ? `
                                    <button class="btn btn-launch" onclick="window.adminDashboard ? window.adminDashboard.launchUrlBot('${url.id}', '${url.url}') : window.userDashboard.launchUrlBot('${url.id}', '${url.url}')">
                                        <i class="fas fa-rocket"></i> Launch Bot
                                    </button>
                                ` : `
                                    <button class="btn btn-disabled" disabled>
                                        <i class="fas fa-clock"></i> Not Ready
                                    </button>
                                `}
                                ${canLaunch ? `
                                    <button class="btn btn-preview" onclick="window.adminDashboard ? window.adminDashboard.previewUrl('${url.url}') : window.userDashboard.previewUrl('${url.url}')">
                                        <i class="fas fa-external-link-alt"></i> Preview
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            showUrlForm() {
                document.getElementById('url-form').classList.add('show');
                document.getElementById('add-url-btn').style.display = 'none';
            }

            hideUrlForm() {
                document.getElementById('url-form').classList.remove('show');
                document.getElementById('add-url-btn').style.display = 'inline-flex';
                document.getElementById('url-submission-form').reset();
            }

            async submitUrl(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const url = formData.get('url');
                const description = formData.get('description');
                
                // Show loading state
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing URL...';
                submitBtn.disabled = true;
                
                // Hide any previous messages
                document.getElementById('message').style.display = 'none';

                try {
                    this.showMessage('üîÑ Processing your URL... This may take a few moments for large websites.', 'info');
                    
                    const response = await fetch('/user/submit-url', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ url, description })
                    });

                    const data = await response.json();

                    if (data.status === 'success') {
                        this.showMessage('‚úÖ URL successfully processed! Content has been added to your chatbot knowledge base.', 'success');
                        this.hideUrlForm();
                        this.loadUserUrls(); // Refresh the list
                    } else {
                        this.showMessage(data.message || 'Failed to process URL', 'error');
                    }
                } catch (error) {
                    console.error('Error submitting URL:', error);
                    this.showMessage('‚ùå Error processing URL. Please try again.', 'error');
                } finally {
                    // Reset button state
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            }

            showMessage(text, type) {
                const messageEl = document.getElementById('message');
                messageEl.textContent = text;
                messageEl.className = `message ${type}`;
                messageEl.style.display = 'block';
                
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 5000);
            }

            launchUrlBot(urlId, urlText) {
                // Launch bot for a specific URL
                const widgetUrl = `/widget?urls=${urlId}&user_id=${this.userInfo.id}`;
                const windowFeatures = 'width=800,height=600,scrollbars=yes,resizable=yes';
                
                const newWindow = window.open(widgetUrl, `ChatbotWidget_${urlId}`, windowFeatures);
                
                if (newWindow) {
                    newWindow.focus();
                    // Truncate URL for display if too long
                    const displayUrl = urlText.length > 40 ? urlText.substring(0, 40) + '...' : urlText;
                    this.showMessage(`üöÄ Chatbot launched for: ${displayUrl}`, 'success');
                } else {
                    this.showMessage('‚ö†Ô∏è Please allow popups and try again', 'error');
                    setTimeout(() => {
                        if (confirm('Open chatbot widget in this tab?')) {
                            window.open(widgetUrl, '_blank');
                        }
                    }, 2000);
                }
            }

            previewUrl(url) {
                // Open URL in new tab for preview
                window.open(url, '_blank');
                this.showMessage(`üîó Opening ${url} in new tab`, 'info');
            }

            launchBotWidget() {
                // Open the chatbot widget in a new window/tab
                const widgetUrl = '/widget';
                const windowFeatures = 'width=800,height=600,scrollbars=yes,resizable=yes';
                
                const newWindow = window.open(widgetUrl, 'ChatbotWidget', windowFeatures);
                
                if (newWindow) {
                    // Focus the new window
                    newWindow.focus();
                    this.showMessage('üöÄ Chatbot widget launched in new window!', 'success');
                } else {
                    // Fallback if popup was blocked
                    this.showMessage('‚ö†Ô∏è Please allow popups and try again, or visit the widget directly.', 'error');
                    // As fallback, navigate to the widget page in the same tab after 2 seconds
                    setTimeout(() => {
                        if (confirm('Open chatbot widget in this tab?')) {
                            window.open(widgetUrl, '_blank');
                        }
                    }, 2000);
                }
            }

            logout() {
                localStorage.removeItem('user_token');
                localStorage.removeItem('user_info');
                window.location.href = '/login';
            }

            // API Key Management Methods
            async loadApiKeyStatus() {
                try {
                    const response = await fetch('/user/api-key/status', {
                        headers: {
                            'Authorization': `Bearer ${this.authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.updateApiKeyStatus(data);
                    } else {
                        this.updateApiKeyStatus({ has_key: false, message: 'Unable to load API key status' });
                    }
                } catch (error) {
                    console.error('Error loading API key status:', error);
                    this.updateApiKeyStatus({ has_key: false, message: 'Error loading API key status' });
                }
            }

            updateApiKeyStatus(data) {
                const statusCard = document.querySelector('.status-card');
                const statusText = document.getElementById('api-key-status-text');
                const editBtn = document.getElementById('edit-api-key-btn');
                const removeBtn = document.getElementById('remove-api-key-btn');

                statusCard.className = 'status-card';
                
                if (data.has_key) {
                    statusCard.classList.add('has-key');
                    statusText.textContent = data.message || 'API key is configured and working properly.';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i> Update API Key';
                    if (removeBtn) removeBtn.style.display = 'inline-flex';
                } else {
                    statusCard.classList.add('no-key');
                    statusText.textContent = data.message || 'No API key configured. Using shared service.';
                    editBtn.innerHTML = '<i class="fas fa-plus"></i> Add API Key';
                    if (removeBtn) removeBtn.style.display = 'none';
                }
            }

            showApiKeyForm() {
                const form = document.getElementById('api-key-form');
                const input = document.getElementById('api-key-input');
                
                form.style.display = 'block';
                input.focus();
                
                // Scroll to form
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            hideApiKeyForm() {
                const form = document.getElementById('api-key-form');
                const input = document.getElementById('api-key-input');
                
                form.style.display = 'none';
                input.value = '';
                this.showApiKeyMessage('', '');
            }

            toggleApiKeyVisibility() {
                const input = document.getElementById('api-key-input');
                const toggleBtn = document.getElementById('toggle-api-key-visibility');
                const icon = toggleBtn.querySelector('i');
                
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.className = 'fas fa-eye-slash';
                } else {
                    input.type = 'password';
                    icon.className = 'fas fa-eye';
                }
            }

            async testApiKey() {
                const input = document.getElementById('api-key-input');
                const testBtn = document.getElementById('test-api-key');
                const apiKey = input.value.trim();

                if (!apiKey) {
                    this.showApiKeyMessage('Please enter an API key first.', 'error');
                    return;
                }

                testBtn.disabled = true;
                testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';

                try {
                    const response = await fetch('/user/api-key/test', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ api_key: apiKey })
                    });

                    const data = await response.json();

                    if (response.ok && data.status === 'success') {
                        this.showApiKeyMessage('‚úÖ API key is valid and working!', 'success');
                    } else {
                        this.showApiKeyMessage(`‚ùå ${data.message || 'API key test failed'}`, 'error');
                    }
                } catch (error) {
                    console.error('Error testing API key:', error);
                    this.showApiKeyMessage('‚ùå Error testing API key. Please try again.', 'error');
                } finally {
                    testBtn.disabled = false;
                    testBtn.innerHTML = '<i class="fas fa-check"></i> Test Key';
                }
            }

            async submitApiKey(e) {
                e.preventDefault();
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const formData = new FormData(e.target);
                const apiKey = formData.get('api_key').trim();

                if (!apiKey) {
                    this.showApiKeyMessage('Please enter an API key.', 'error');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                try {
                    const response = await fetch('/user/api-key', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ api_key: apiKey })
                    });

                    const data = await response.json();

                    if (response.ok && data.status === 'success') {
                        this.showApiKeyMessage('‚úÖ API key saved successfully!', 'success');
                        this.hideApiKeyForm();
                        this.loadApiKeyStatus(); // Refresh status
                    } else {
                        this.showApiKeyMessage(`‚ùå ${data.message || 'Failed to save API key'}`, 'error');
                    }
                } catch (error) {
                    console.error('Error saving API key:', error);
                    this.showApiKeyMessage('‚ùå Error saving API key. Please try again.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Save API Key';
                }
            }

            async removeApiKey() {
                if (!confirm('Are you sure you want to remove your API key? This will switch you back to the shared service.')) {
                    return;
                }

                const removeBtn = document.getElementById('remove-api-key-btn');
                removeBtn.disabled = true;
                removeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removing...';

                try {
                    const response = await fetch('/user/api-key', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${this.authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (response.ok && data.status === 'success') {
                        this.showApiKeyMessage('‚úÖ API key removed successfully!', 'success');
                        this.loadApiKeyStatus(); // Refresh status
                    } else {
                        this.showApiKeyMessage(`‚ùå ${data.message || 'Failed to remove API key'}`, 'error');
                    }
                } catch (error) {
                    console.error('Error removing API key:', error);
                    this.showApiKeyMessage('‚ùå Error removing API key. Please try again.', 'error');
                } finally {
                    removeBtn.disabled = false;
                    removeBtn.innerHTML = '<i class="fas fa-trash"></i> Remove API Key';
                }
            }

            showApiKeyMessage(message, type) {
                const messageEl = document.getElementById('api-key-message');
                
                if (!message) {
                    messageEl.style.display = 'none';
                    return;
                }

                messageEl.className = `message ${type}`;
                messageEl.textContent = message;
                messageEl.style.display = 'block';

                // Auto-hide success messages after 5 seconds
                if (type === 'success') {
                    setTimeout(() => {
                        messageEl.style.display = 'none';
                    }, 5000);
                }
            }
        }

        // Initialize dashboard
        new UserDashboard();
    </script>
</body>
</html>